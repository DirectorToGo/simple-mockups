<section>
  <div class="flex flex-wrap items-center gap-3">
    <h1 class="text-2xl font-semibold text-gray-900">Plan Admin</h1>
    <button type="button"
            (click)="onAddPlan()"
            class="btn btn-primary btn-sm">
      <span class="text-base leading-none">+</span>
      Add plan
    </button>
  </div>

  <div class="mt-6 flex flex-col gap-3 sm:flex-row sm:items-center">
    <div class="relative flex-1">
      <input type="search"
             (input)="onPlanSearchInput($event)"
             [value]="planSearchQuery()"
             placeholder="Looking for something..."
             class="block w-full pl-9 pr-3 py-2.5 text-sm border border-gray-300 rounded-md bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
      <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11ZM2 9a7 7 0 1 1 12.452 4.391l3.328 3.329a.75.75 0 0 1-1.06 1.06l-3.329-3.328A7 7 0 0 1 2 9Z" clip-rule="evenodd" />
      </svg>
    </div>
    <button type="button"
            class="relative flex items-center justify-center px-3.5 py-2.5 border border-gray-300 rounded-md shadow-sm text-xs font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
      @if (planFilterCount() > 0) {
        <span class="absolute -top-2 -right-2 flex items-center justify-center w-4 h-4 bg-pink-600 text-white rounded-full text-[10px]">{{ planFilterCount() }}</span>
      }
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1.5 text-gray-500">
        <path fill-rule="evenodd" d="M2.628 1.601C5.028 1.206 7.49 1 10 1s4.973.206 7.372.601a.75.75 0 0 1 .628.74v2.288a2.25 2.25 0 0 1-.659 1.59l-4.682 4.683a2.25 2.25 0 0 0-.659 1.59v3.037c0 .684-.31 1.33-.844 1.757l-1.937 1.55A.75.75 0 0 1 8 18.25v-5.757a2.25 2.25 0 0 0-.659-1.59L2.659 6.22A2.25 2.25 0 0 1 2 4.629V2.34a.75.75 0 0 1 .628-.74Z" clip-rule="evenodd" />
      </svg>
      Filters
    </button>
  </div>

  <div class="mt-6 bg-white shadow-lg rounded-lg border border-gray-200 overflow-hidden">
    <table class="w-full text-sm text-left text-gray-600">
      <thead class="bg-gray-50 text-xs font-medium text-gray-500">
        <tr>
          <th scope="col" class="px-4 py-2 w-32"></th>
          <th scope="col" class="px-4 py-2">Plan name</th>
          <th scope="col" class="px-4 py-2">Description</th>
          <th scope="col" class="px-4 py-2 w-40">Assignees</th>
          <th scope="col" class="px-4 py-2 w-24">Status</th>
        </tr>
      </thead>
      <tbody>
        @for (plan of filteredPlans(); track trackPlanById($index, plan)) {
          <tr class="border-b hover:bg-gray-50 transition-colors duration-200"
              [ngClass]="isSelectedPlan(plan.id) ? 'bg-pink-50' : 'bg-white'">
            <td class="px-4 py-3 align-top">
              <div class="relative inline-flex rounded shadow-sm">
                <button type="button"
                        (click)="onSelectPlan(plan.id)"
                        class="w-14 text-center bg-pink-600 text-white text-xs font-medium px-2.5 py-1.5 rounded-l hover:bg-pink-700 focus:z-10 focus:ring-2 focus:ring-pink-500 transition-colors">
                  Edit
                </button>
                <button type="button"
                        (click)="togglePlanActionDropdown($event, plan.id)"
                        class="bg-pink-600 text-white px-1.5 py-1.5 rounded-r border-l border-pink-500 hover:bg-pink-700 focus:z-10 focus:ring-2 focus:ring-pink-500 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06z" clip-rule="evenodd" />
                  </svg>
                </button>
                <div class="absolute top-full left-0 mt-2 w-32 bg-white rounded-md shadow-lg z-10 border border-gray-200 origin-top-left transition-all duration-200 ease-out"
                     [class.opacity-100]="planActionDropdownOpen() === plan.id"
                     [class.scale-100]="planActionDropdownOpen() === plan.id"
                     [class.opacity-0]="planActionDropdownOpen() !== plan.id"
                     [class.scale-95]="planActionDropdownOpen() !== plan.id"
                     [class.invisible]="planActionDropdownOpen() !== plan.id">
                  <ul class="py-1 text-sm text-gray-700">
                    <li>
                      <button type="button"
                              (click)="onPlanDelete(plan.id)"
                              class="w-full px-3 py-2 text-left text-red-600 hover:bg-gray-100 transition-colors">
                        Delete Plan
                      </button>
                    </li>
                  </ul>
                </div>
              </div>
            </td>
            <td class="px-4 py-3 align-top">
              <div class="text-sm font-semibold text-gray-900">{{ plan.name }}</div>
              <div class="mt-1 text-xs text-gray-500">Owner: {{ plan.owner }}</div>
              <div class="mt-0.5 text-xs text-gray-400">{{ getPlanTaskCount(plan) }} tasks</div>
            </td>
            <td class="px-4 py-3 align-top">
              <p class="text-sm text-gray-600 leading-relaxed">{{ plan.description }}</p>
            </td>
            <td class="px-4 py-3 align-top">
              <div class="flex -space-x-2">
                @for (assignee of plan.assignees; track assignee.id) {
                  <div class="w-8 h-8 rounded-full border-2 border-white flex items-center justify-center text-xs font-semibold"
                       [ngClass]="getAssigneeColor(assignee.name)"
                       [title]="assignee.name">
                    {{ getAssigneeInitials(assignee.name) }}
                  </div>
                }
              </div>
            </td>
            <td class="px-4 py-3 align-top">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold"
                    [ngClass]="plan.isActive ? 'bg-pink-50 text-pink-700 border border-pink-200' : 'bg-gray-100 text-gray-600 border border-gray-200'">
                {{ plan.isActive ? 'Active' : 'Inactive' }}
              </span>
            </td>
          </tr>
        } @empty {
          <tr>
            <td colspan="5" class="px-4 py-10 text-center text-gray-500">
              <div class="flex flex-col items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5A2.25 2.25 0 0 1 5.25 5.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25A1.5 1.5 0 0 1 19.5 20.25h-15A1.5 1.5 0 0 1 3 18.75V7.5Zm6.75 6.75h4.5m-6-3h7.5m-7.5-3h7.5" />
                </svg>
                <p class="font-semibold">No plans match your search</p>
                <p class="text-sm">Try adjusting the search text or add a new plan.</p>
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  @if (panelOpen()) {
    <div class="fixed inset-0 z-30 flex justify-end">
      <div class="flex-1 bg-gray-900/40" (click)="onClosePanel()"></div>
      @if (selectedPlan(); as plan) {
        <aside class="relative w-full h-full bg-white shadow-2xl border-l border-gray-200 flex flex-col max-w-[80vw]">
          <div class="bg-gray-100 border-b border-gray-200">
            <div class="flex items-center justify-between px-5 py-3">
              <nav class="flex items-center flex-1" aria-label="Plan detail tabs">
                <button type="button"
                        (click)="selectPanelTab('details')"
                        class="flex-1 px-6 py-3 text-sm font-medium border-b-2"
                        [class]="panelTab() === 'details' ? 'bg-white text-pink-600 border-pink-600' : 'bg-gray-200 text-gray-600 border-transparent'">
                  Details
                </button>
                <button type="button"
                        (click)="selectPanelTab('assign')"
                        class="flex-1 px-6 py-3 text-sm font-medium border-b-2"
                        [class]="panelTab() === 'assign' ? 'bg-white text-pink-600 border-pink-600' : 'bg-gray-200 text-gray-600 border-transparent'">
                  Assign
                </button>
                <button type="button"
                        (click)="selectPanelTab('reviewers')"
                        class="flex-1 px-6 py-3 text-sm font-medium border-b-2"
                        [class]="panelTab() === 'reviewers' ? 'bg-white text-pink-600 border-pink-600' : 'bg-gray-200 text-gray-600 border-transparent'">
                  Reviewers
                </button>
              </nav>
              <button type="button" (click)="onClosePanel()" class="ml-3 p-2 text-gray-500 hover:text-gray-700 rounded-full hover:bg-gray-200">
                <span class="material-symbols-outlined text-xl">close</span>
              </button>
            </div>
          </div>

          <div class="flex-1 overflow-y-auto">
            @switch (panelTab()) {
              @case ('details') {
                <div class="px-6 py-6 space-y-6 text-sm text-gray-700">
                  <div>
                    <label for="plan-name" class="block text-xs font-semibold text-gray-500 tracking-wide">Plan Name</label>
                    <input id="plan-name"
                           type="text"
                           [value]="plan.name"
                           (input)="onPlanNameInput($event)"
                           class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-gray-900">
                  </div>

                  <div>
                    <label for="plan-description" class="block text-xs font-semibold text-gray-500 tracking-wide">Description</label>
                    <textarea id="plan-description"
                              rows="3"
                              [value]="plan.description"
                              (input)="onPlanDescriptionInput($event)"
                              class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-gray-900"></textarea>
                  </div>

                  <div>
                    <label class="block text-xs font-semibold text-gray-500 tracking-wide mb-1">Term</label>
                    <div class="relative">
                      <button #planTermButton type="button" (click)="toggleTermDropdown()" class="flex items-center justify-between w-full pl-3 pr-2 py-2.5 text-sm border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                        <span class="truncate">{{ selectedTerm() }}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 0 1 1.414 0L10 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0l-4-4a1 1 0 0 1 0-1.414Z" clip-rule="evenodd" />
                        </svg>
                      </button>
                      <div #planTermDropdown
                           class="absolute left-0 mt-2 w-64 bg-white rounded-md shadow-lg border border-gray-200 z-20"
                           [class.hidden]="!termDropdownOpen()">
                        <app-term-filter-dropdown
                          selectionMode="single"
                          [selected]="selectedTerm()"
                          (selectionChange)="onTermSelectionChange($event)">
                        </app-term-filter-dropdown>
                      </div>
                    </div>
                  </div>

                  <div class="space-y-3">
                    <div class="flex items-center gap-3">
                      <h3 class="text-base font-semibold text-gray-900">Tasks</h3>
                      <button type="button"
                              (click)="onAddTask()"
                              [disabled]="!panelOpen()"
                              class="btn btn-primary btn-sm disabled:opacity-60">
                        <span class="text-base leading-none">+</span>
                        Add task
                      </button>
                    </div>

                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                      <table class="w-full text-sm text-left text-gray-600">
                        <thead class="bg-gray-50 text-[11px] text-gray-500 tracking-wide">
                          <tr>
                            <th scope="col" class="px-4 py-2 w-28"></th>
                            <th scope="col" class="px-4 py-2">
                              <button (click)="sortTasksBy('name')" class="flex items-center space-x-1 group">
                                <span class="group-hover:text-gray-900">Name</span>
                                <span class="flex flex-col">
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 -mb-1.5" [class]="taskSort()?.key === 'name' && taskSort()?.direction === 'asc' ? 'text-gray-900' : 'text-gray-400 group-hover:text-gray-500'">
                                    <path fill-rule="evenodd" d="M14.77 12.79a.75.75 0 0 1-1.06 0L10 9.06l-3.71 3.73a.75.75 0 0 1-1.06-1.06l4.25-4.25a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06Z" clip-rule="evenodd" />
                                  </svg>
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4" [class]="taskSort()?.key === 'name' && taskSort()?.direction === 'desc' ? 'text-gray-900' : 'text-gray-400 group-hover:text-gray-500'">
                                    <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 0 1 1.06 0L10 10.94l3.71-3.73a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.23 8.27a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                                  </svg>
                                </span>
                              </button>
                            </th>
                            <th scope="col" class="px-4 py-2">Description</th>
                            <th scope="col" class="px-4 py-2">
                              <button (click)="sortTasksBy('source')" class="flex items-center space-x-1 group">
                                <span class="group-hover:text-gray-900">Source Data</span>
                                <span class="flex flex-col">
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 -mb-1.5" [class]="taskSort()?.key === 'source' && taskSort()?.direction === 'asc' ? 'text-gray-900' : 'text-gray-400 group-hover:text-gray-500'">
                                    <path fill-rule="evenodd" d="M14.77 12.79a.75.75 0 0 1-1.06 0L10 9.06l-3.71 3.73a.75.75 0 1 1-1.06-1.06l4.25-4.25a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06Z" clip-rule="evenodd" />
                                  </svg>
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4" [class]="taskSort()?.key === 'source' && taskSort()?.direction === 'desc' ? 'text-gray-900' : 'text-gray-400 group-hover:text-gray-500'">
                                    <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 0 1 1.06 0L10 10.94l3.71-3.73a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.23 8.27a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                                  </svg>
                                </span>
                              </button>
                            </th>
                            <th scope="col" class="px-4 py-2 w-32">
                              <button (click)="sortTasksBy('display')" class="flex items-center space-x-1 group">
                                <span class="group-hover:text-gray-900">Display</span>
                                <span class="flex flex-col">
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 -mb-1.5" [class]="taskSort()?.key === 'display' && taskSort()?.direction === 'asc' ? 'text-gray-900' : 'text-gray-400 group-hover:text-gray-500'">
                                    <path fill-rule="evenodd" d="M14.77 12.79a.75.75 0 0 1-1.06 0L10 9.06l-3.71 3.73a.75.75 0 1 1-1.06-1.06l4.25-4.25a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06Z" clip-rule="evenodd" />
                                  </svg>
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4" [class]="taskSort()?.key === 'display' && taskSort()?.direction === 'desc' ? 'text-gray-900' : 'text-gray-400 group-hover:text-gray-500'">
                                    <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 0 1 1.06 0L10 10.94l3.71-3.73a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.23 8.27a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                                  </svg>
                                </span>
                              </button>
                            </th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (entry of tasks(); track trackTaskById($index, entry)) {
                            <tr class="border-t border-gray-100">
                              <td class="px-4 py-3 align-top">
                                <div class="relative inline-flex shadow-sm rounded-md">
                                  <button type="button"
                                          (click)="onEditTask(entry.task.id)"
                                          class="w-14 text-center bg-pink-600 text-white text-xs font-medium px-2.5 py-1.5 rounded-l hover:bg-pink-700 focus:z-10 focus:ring-2 focus:ring-pink-500">
                                    Edit
                                  </button>
                                  <button type="button"
                                          (click)="toggleActionDropdown($event, entry.task.id)"
                                          class="bg-pink-600 text-white px-1.5 py-1.5 rounded-r border-l border-pink-500 hover:bg-pink-700 focus:z-10 focus:ring-2 focus:ring-pink-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                      <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 0 1 1.06 0L10 10.94l3.71-3.73a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.23 8.27a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                                    </svg>
                                  </button>
                                  <div class="absolute left-0 top-full mt-2 w-32 bg-white border border-gray-200 rounded-md shadow-lg z-10"
                                       [class.hidden]="actionDropdownOpen() !== entry.task.id">
                                    <ul class="py-1 text-sm">
                                      <li>
                                        <button type="button"
                                                (click)="onDeleteTask(entry.task.id)"
                                                class="w-full px-3 py-2 text-left text-red-600 hover:bg-gray-100">
                                          Delete Task
                                        </button>
                                      </li>
                                    </ul>
                                  </div>
                                </div>
                              </td>
                              <td class="px-4 py-3 align-top">
                                <div class="text-sm font-medium text-gray-900">{{ entry.task.name }}</div>
                              </td>
                              <td class="px-4 py-3 align-top text-sm text-gray-600">
                                {{ entry.task.description || 'No description provided.' }}
                              </td>
                              <td class="px-4 py-3 align-top text-sm text-gray-600">
                                <div class="flex flex-wrap gap-1.5">
                                  @if (getSources(entry).length > 0) {
                                    @for (source of getSources(entry); track source) {
                                      <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-xs font-medium text-gray-700">{{ source }}</span>
                                    }
                                  } @else {
                                    <span class="text-xs text-gray-500 italic">No sources selected</span>
                                  }
                                </div>
                              </td>
                              <td class="px-4 py-3 align-top">
                                <span class="inline-flex items-center px-3 py-1 rounded-full bg-gray-100 text-xs font-medium text-gray-700">{{ entry.task.displayType }}</span>
                              </td>
                            </tr>
                          } @empty {
                            <tr>
                              <td colspan="5" class="px-4 py-10 text-center text-gray-500">
                                <div class="flex flex-col items-center gap-2">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M4 3a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h4l2 2 2-2h4a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2H4Z" />
                                  </svg>
                                  <p class="font-semibold">No tasks for {{ selectedTerm() }}</p>
                                  <p class="text-sm">Add a task to start tracking progress for this term.</p>
                                  <button type="button" (click)="onAddTask()" class="btn btn-primary btn-sm mt-2">
                                    <span class="text-base leading-none">+</span>
                                    Add task
                                  </button>

                                </div>
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div class="flex items-center gap-3 border-t border-gray-200 pt-4">
                    <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700">
                      <input type="checkbox"
                             class="h-4 w-4 text-pink-600 rounded border-gray-300 focus:ring-pink-500"
                             [checked]="plan.isActive"
                             (change)="onPlanActiveToggle($event)">
                      Active
                    </label>
                  </div>
                </div>
              }
              @case ('assign') {
                <div class="px-6 py-6 text-sm text-gray-600">
                  Assignment workflows are coming soon. Use the Details tab to keep plan information current in the meantime.
                </div>
              }
              @case ('reviewers') {
                <div class="px-6 py-6 text-sm text-gray-700 space-y-4">
                  <div class="flex items-center justify-between">
                    <h3 class="text-base font-semibold text-gray-900">Reviewers</h3>
                    <button type="button" class="btn btn-primary btn-sm">
                      <span class="text-base leading-none">+</span>
                      Add reviewer
                    </button>
                  </div>

                  <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                      <thead class="bg-gray-50 text-xs font-semibold text-gray-500 tracking-wide">
                        <tr>
                          <th scope="col" class="px-4 py-2 text-left">Name</th>
                          <th scope="col" class="px-4 py-2 text-left">Role</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-100">
                        @for (reviewer of plan.assignees; track reviewer.id) {
                          <tr class="bg-white">
                            <td class="px-4 py-2">
                              <div class="flex items-center gap-2">
                                <span class="flex items-center justify-center w-8 h-8 rounded-full text-xs font-semibold border border-white/40" [ngClass]="getAssigneeColor(reviewer.name)">{{ getAssigneeInitials(reviewer.name) }}</span>
                                <span class="text-gray-900">{{ reviewer.name }}</span>
                              </div>
                            </td>
                            <td class="px-4 py-2 text-gray-600">{{ reviewer.role || 'Reviewer' }}</td>
                          </tr>
                        } @empty {
                          <tr>
                            <td colspan="2" class="px-4 py-6 text-center text-gray-500">
                              No reviewers assigned yet. Add reviewers to keep collaborators informed.
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                </div>
              }
            }
          </div>
        </aside>
      }
    </div>
  }
</section>
