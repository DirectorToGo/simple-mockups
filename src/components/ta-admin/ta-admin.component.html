<section>
  <div class="flex flex-wrap items-center gap-3">
    <h1 class="text-2xl font-semibold text-gray-900">TA Admin</h1>
    <button type="button"
            (click)="onAddBot()"
            class="btn btn-primary btn-sm">
      <span class="text-base leading-none">+</span>
      Add bot
    </button>
  </div>

  <div class="mt-6 flex flex-col gap-3 sm:flex-row sm:items-center">
    <div class="relative flex-1">
      <input type="search"
             (input)="onBotSearchInput($event)"
             [value]="botSearchQuery()"
             placeholder="Looking for something..."
             class="block w-full pl-9 pr-3 py-2.5 text-sm border border-gray-300 rounded-md bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
      <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11ZM2 9a7 7 0 1 1 12.452 4.391l3.328 3.329a.75.75 0 0 1-1.06 1.06l-3.329-3.328A7 7 0 0 1 2 9Z" clip-rule="evenodd" />
      </svg>
    </div>
    <button type="button"
            class="relative flex items-center justify-center px-3.5 py-2.5 border border-gray-300 rounded-md shadow-sm text-xs font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
      @if (botFilterCount() > 0) {
        <span class="absolute -top-2 -right-2 flex items-center justify-center w-4 h-4 bg-pink-600 text-white rounded-full text-[10px]">{{ botFilterCount() }}</span>
      }
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1.5 text-gray-500">
        <path fill-rule="evenodd" d="M2.628 1.601C5.028 1.206 7.49 1 10 1s4.973.206 7.372.601a.75.75 0 0 1 .628.74v2.288a2.25 2.25 0 0 1-.659 1.59l-4.682 4.683a2.25 2.25 0 0 0-.659 1.59v3.037c0 .684-.31 1.33-.844 1.757l-1.937 1.55A.75.75 0 0 1 8 18.25v-5.757a2.25 2.25 0 0 0-.659-1.59L2.659 6.22A2.25 2.25 0 0 1 2 4.629V2.34a.75.75 0 0 1 .628-.74Z" clip-rule="evenodd" />
      </svg>
      Filters
    </button>
  </div>

  <div class="mt-6 bg-white shadow-lg rounded-lg border border-gray-200 overflow-hidden">
    <table class="w-full text-sm text-left text-gray-600">
      <thead class="bg-gray-50 text-xs font-medium text-gray-500">
        <tr>
          <th scope="col" class="px-4 py-2 w-32"></th>
          <th scope="col" class="px-4 py-2">Bot name</th>
          <th scope="col" class="px-4 py-2">Description</th>
          <th scope="col" class="px-4 py-2 w-40">Roles</th>
          <th scope="col" class="px-4 py-2 w-24">Status</th>
          <th scope="col" class="px-4 py-2 w-24">Temperature</th>
        </tr>
      </thead>
      <tbody>
        @for (bot of filteredBots(); track trackBotById($index, bot)) {
          <tr class="border-b hover:bg-gray-50 transition-colors duration-200"
              [ngClass]="isSelectedBot(bot.id) ? 'bg-pink-50' : 'bg-white'">
            <td class="px-4 py-3 align-top">
              <div class="relative inline-flex rounded shadow-sm">
                <button type="button"
                        (click)="onSelectBot(bot.id)"
                        class="w-14 text-center bg-pink-600 text-white text-xs font-medium px-2.5 py-1.5 rounded-l hover:bg-pink-700 focus:z-10 focus:ring-2 focus:ring-pink-500 transition-colors">
                  Edit
                </button>
                <button type="button"
                        (click)="toggleBotActionDropdown($event, bot.id)"
                        class="bg-pink-600 text-white px-1.5 py-1.5 rounded-r border-l border-pink-500 hover:bg-pink-700 focus:z-10 focus:ring-2 focus:ring-pink-500 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06z" clip-rule="evenodd" />
                  </svg>
                </button>
                <div class="absolute top-full left-0 mt-2 w-32 bg-white rounded-md shadow-lg z-10 border border-gray-200 origin-top-left transition-all duration-200 ease-out"
                     [class.opacity-100]="botActionDropdownOpen() === bot.id"
                     [class.scale-100]="botActionDropdownOpen() === bot.id"
                     [class.opacity-0]="botActionDropdownOpen() !== bot.id"
                     [class.scale-95]="botActionDropdownOpen() !== bot.id"
                     [class.invisible]="botActionDropdownOpen() !== bot.id">
                  <ul class="py-1 text-sm text-gray-700">
                    <li>
                      <button type="button"
                              (click)="onBotClone(bot.id)"
                              class="w-full px-3 py-2 text-left text-gray-700 hover:bg-gray-100 transition-colors">
                        Clone Bot
                      </button>
                    </li>
                    <li>
                      <button type="button"
                              (click)="onBotDelete(bot.id)"
                              class="w-full px-3 py-2 text-left text-red-600 hover:bg-gray-100 transition-colors">
                        Delete Bot
                      </button>
                    </li>
                  </ul>
                </div>
              </div>
            </td>
            <td class="px-4 py-3 align-top">
              <div class="text-sm font-semibold text-gray-900">{{ bot.name }}</div>
              <div class="mt-1 text-xs text-gray-500">Creator: {{ bot.creatorName || 'System' }}</div>
              <div class="mt-0.5 text-xs text-gray-400">{{ bot.defaultPrompts.length }} prompts</div>
            </td>
            <td class="px-4 py-3 align-top">
              <p class="text-sm text-gray-600 leading-relaxed">{{ bot.description || 'No description provided.' }}</p>
            </td>
            <td class="px-4 py-3 align-top">
              <div class="flex flex-wrap gap-1.5">
                @for (role of bot.roles; track role) {
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-xs font-medium text-gray-700">{{ role }}</span>
                }
              </div>
            </td>
            <td class="px-4 py-3 align-top">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold"
                    [ngClass]="bot.status === 'Published' ? 'bg-pink-50 text-pink-700 border border-pink-200' : 'bg-gray-100 text-gray-600 border border-gray-200'">
                {{ bot.status }}
              </span>
            </td>
            <td class="px-4 py-3 align-top">
              <span class="text-sm text-gray-600">{{ bot.temperature }}</span>
            </td>
          </tr>
        } @empty {
          <tr>
            <td colspan="6" class="px-4 py-10 text-center text-gray-500">
              <div class="flex flex-col items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5A2.25 2.25 0 0 1 5.25 5.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25A1.5 1.5 0 0 1 19.5 20.25h-15A1.5 1.5 0 0 1 3 18.75V7.5Zm6.75 6.75h4.5m-6-3h7.5m-7.5-3h7.5" />
                </svg>
                <p class="font-semibold">No bots match your search</p>
                <p class="text-sm">Try adjusting the search text or add a new bot.</p>
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  @if (panelOpen()) {
    <div class="fixed inset-0 z-30 flex justify-end">
      <div class="flex-1 bg-gray-900/40" (click)="onClosePanel()"></div>
      @if (editingBot(); as bot) {
        <aside class="relative w-full h-full bg-white shadow-2xl border-l border-gray-200 flex flex-col max-w-[80vw]">
          <div class="bg-gray-100 border-b border-gray-200">
            <div class="flex items-center justify-between px-5 py-3">
              <nav class="flex items-center flex-1" aria-label="Bot detail tabs">
                <button type="button"
                        (click)="selectPanelTab('details')"
                        class="flex-1 px-6 py-3 text-sm font-medium border-b-2"
                        [class]="panelTab() === 'details' ? 'bg-white text-pink-600 border-pink-600' : 'bg-gray-200 text-gray-600 border-transparent'">
                  Details
                </button>
                <button type="button"
                        (click)="selectPanelTab('roles')"
                        class="flex-1 px-6 py-3 text-sm font-medium border-b-2"
                        [class]="panelTab() === 'roles' ? 'bg-white text-pink-600 border-pink-600' : 'bg-gray-200 text-gray-600 border-transparent'">
                  Roles
                </button>
                <button type="button"
                        (click)="selectPanelTab('assign')"
                        class="flex-1 px-6 py-3 text-sm font-medium border-b-2"
                        [class]="panelTab() === 'assign' ? 'bg-white text-pink-600 border-pink-600' : 'bg-gray-200 text-gray-600 border-transparent'">
                  Assign
                </button>
              </nav>
              <button type="button" (click)="onClosePanel()" class="ml-3 p-2 text-gray-500 hover:text-gray-700 rounded-full hover:bg-gray-200">
                <span class="material-symbols-outlined text-xl">close</span>
              </button>
            </div>
          </div>

          <div class="flex-1 overflow-y-auto">
            @switch (panelTab()) {
              @case ('details') {
                <div class="px-6 py-6 space-y-6 text-sm text-gray-700">
                  <div>
                    <label for="bot-name" class="block text-xs font-semibold text-gray-500 tracking-wide">Bot Name</label>
                    <input id="bot-name"
                           type="text"
                           [value]="bot.name"
                           (input)="onBotNameInput($event)"
                           class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-gray-900">
                  </div>

                  <div>
                    <label for="bot-description" class="block text-xs font-semibold text-gray-500 tracking-wide">Description</label>
                    <textarea id="bot-description"
                              rows="3"
                              [value]="bot.description || ''"
                              (input)="onBotDescriptionInput($event)"
                              class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-gray-900"></textarea>
                  </div>

                  <div>
                    <label class="block text-xs font-semibold text-gray-500 tracking-wide mb-1">Context Sources</label>
                    <div class="flex flex-wrap gap-2">
                      @for (opt of contextOptions; track opt) {
                        <label class="inline-flex items-center gap-2 px-2 py-1 rounded border cursor-pointer text-sm" [class]="bot.contextTypes.includes(opt) ? 'bg-pink-50 text-pink-700 border-pink-200' : 'bg-white text-gray-700 border-gray-300'">
                          <input type="checkbox" class="sr-only" [checked]="bot.contextTypes.includes(opt)" (change)="toggleContext(opt)">
                          <span>{{ opt }}</span>
                        </label>
                      }
                    </div>
                  </div>


                  <div class="space-y-3">
                    <div class="flex items-center gap-3">
                      <h3 class="text-base font-semibold text-gray-900">Default Chat Options</h3>
                      <button type="button"
                              (click)="addPrompt()"
                              class="btn btn-primary btn-sm">
                        <span class="text-base leading-none">+</span>
                        Add prompt
                      </button>
                    </div>

                    <div class="space-y-2">
                      @for (p of bot.defaultPrompts; let i = $index; track i) {
                        <div class="flex items-center gap-2">
                          <div class="relative inline-flex rounded shadow-sm">
                            <button type="button" 
                                    (click)="focusPromptInput(i)"
                                    class="w-14 text-center bg-pink-600 text-white text-xs font-medium px-2.5 py-1.5 rounded-l hover:bg-pink-700 focus:z-10 focus:ring-2 focus:ring-pink-500 transition-colors">
                              Edit
                            </button>
                            <button type="button" 
                                    (click)="togglePromptDropdown($event, i)"
                                    class="bg-pink-600 text-white px-1.5 py-1.5 rounded-r border-l border-pink-500 hover:bg-pink-700 focus:z-10 focus:ring-2 focus:ring-pink-500 transition-colors">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06z" clip-rule="evenodd" />
                              </svg>
                            </button>
                            <div class="absolute top-full left-0 mt-2 w-32 bg-white rounded-md shadow-lg z-10 border border-gray-200 origin-top-left transition-all duration-200 ease-out"
                                 [class.opacity-100]="promptDropdownOpen() === i"
                                 [class.scale-100]="promptDropdownOpen() === i"
                                 [class.opacity-0]="promptDropdownOpen() !== i"
                                 [class.scale-95]="promptDropdownOpen() !== i"
                                 [class.invisible]="promptDropdownOpen() !== i">
                              <ul class="py-1 text-sm text-gray-700">
                                <li>
                                  <button type="button"
                                          (click)="movePrompt(i, -1); promptDropdownOpen.set(null)"
                                          class="w-full px-3 py-2 text-left text-gray-700 hover:bg-gray-100 transition-colors"
                                          [disabled]="i === 0">
                                    Move Up
                                  </button>
                                </li>
                                <li>
                                  <button type="button"
                                          (click)="movePrompt(i, 1); promptDropdownOpen.set(null)"
                                          class="w-full px-3 py-2 text-left text-gray-700 hover:bg-gray-100 transition-colors"
                                          [disabled]="i === bot.defaultPrompts.length - 1">
                                    Move Down
                                  </button>
                                </li>
                                <li>
                                  <button type="button"
                                          (click)="removePrompt(i); promptDropdownOpen.set(null)"
                                          class="w-full px-3 py-2 text-left text-red-600 hover:bg-gray-100 transition-colors">
                                    Remove
                                  </button>
                                </li>
                              </ul>
                            </div>
                          </div>
                          <input type="text" 
                                 data-prompt-index="{{ i }}"
                                 class="flex-1 px-3 py-2 text-sm rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500" 
                                 [value]="p" 
                                 (input)="updatePrompt(i, ($any($event.target)).value)">
                        </div>
                      } @empty {
                        <div class="text-sm text-gray-500">No prompts yet.</div>
                      }
                    </div>
                  </div>

                  <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-base font-semibold text-gray-900 mb-4">AI Parameters</h3>
                    <div class="space-y-4">
                      <div>
                        <label for="temperature-range" class="block text-xs font-semibold text-gray-500 tracking-wide mb-1">Temperature (0.0–1.0)</label>
                        <div class="flex items-center gap-3">
                          <input id="temperature-range"
                                 type="range" 
                                 min="0" 
                                 max="1" 
                                 step="0.1" 
                                 class="flex-1" 
                                 [value]="bot.temperature" 
                                 (input)="updateTemperature(Number(($any($event.target)).value))">
                          <input type="number" 
                                 min="0" 
                                 max="1" 
                                 step="0.1" 
                                 class="w-20 px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-gray-900" 
                                 [value]="bot.temperature" 
                                 (input)="updateTemperature(Number(($any($event.target)).value))">
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Controls creativity/randomness of responses.</p>
                      </div>
                      <div>
                        <label for="confidence-range" class="block text-xs font-semibold text-gray-500 tracking-wide mb-1">Confidence Threshold (0–100%)</label>
                        <div class="flex items-center gap-3">
                          <input id="confidence-range"
                                 type="range" 
                                 min="0" 
                                 max="100" 
                                 step="5" 
                                 class="flex-1" 
                                 [value]="bot.confidencePercent" 
                                 (input)="updateConfidencePercent(Number(($any($event.target)).value))">
                          <input type="number" 
                                 min="0" 
                                 max="100" 
                                 step="1" 
                                 class="w-20 px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-gray-900" 
                                 [value]="bot.confidencePercent" 
                                 (input)="updateConfidencePercent(Number(($any($event.target)).value))">
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Minimum confidence to surface results.</p>
                      </div>
                    </div>
                  </div>

                  <div class="border-t border-gray-200 pt-6">
                    <div class="flex items-center gap-6">
                      <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700">
                        <input type="checkbox"
                               class="h-4 w-4 text-pink-600 rounded border-gray-300 focus:ring-pink-500"
                               [checked]="bot.active"
                               (change)="onBotActiveToggle($event)">
                        Active
                      </label>
                      <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-700">
                        <input type="checkbox"
                               class="h-4 w-4 text-pink-600 rounded border-gray-300 focus:ring-pink-500"
                               [checked]="bot.status === 'Published'"
                               (change)="onBotStatusToggle($event)">
                        Published
                      </label>
                    </div>
                  </div>
                </div>
              }
              @case ('roles') {
                <div class="px-6 py-6 space-y-6 text-sm text-gray-700">
                  <div>
                    <label class="block text-xs font-semibold text-gray-500 tracking-wide mb-1">Available to Roles</label>
                    <div class="flex flex-wrap gap-2">
                      @for (r of roleOptions; track r) {
                        <label class="inline-flex items-center gap-2 px-2 py-1 rounded border cursor-pointer text-sm" [class]="bot.roles.includes(r) ? 'bg-pink-50 text-pink-700 border-pink-200' : 'bg-white text-gray-700 border-gray-300'">
                          <input type="checkbox" class="sr-only" [checked]="bot.roles.includes(r)" (change)="toggleRole(r)">
                          <span>{{ r }}</span>
                        </label>
                      }
                    </div>
                  </div>

                  <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-base font-semibold text-gray-900 mb-4">Users with Access</h3>
                    <div class="bg-white shadow-lg rounded-lg border border-gray-200 overflow-hidden">
                      <table class="w-full text-sm text-left text-gray-600">
                        <thead class="bg-gray-50 text-xs font-medium text-gray-500">
                          <tr>
                            <th scope="col" class="px-4 py-2">User Name</th>
                            <th scope="col" class="px-4 py-2">Role</th>
                            <th scope="col" class="px-4 py-2">Access Status</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (user of availableUsers(); track user.name) {
                            <tr class="border-b hover:bg-gray-50 transition-colors duration-200">
                              <td class="px-4 py-3 font-medium text-gray-900">{{ user.name }}</td>
                              <td class="px-4 py-3">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-xs font-medium text-gray-700">{{ user.role }}</span>
                              </td>
                              <td class="px-4 py-3">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-50 text-green-700 border border-green-200">
                                  Available
                                </span>
                              </td>
                            </tr>
                          } @empty {
                            <tr>
                              <td colspan="3" class="px-4 py-10 text-center text-gray-500">
                                <div class="flex flex-col items-center gap-2">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
                                  </svg>
                                  <p class="font-semibold">No users available</p>
                                  <p class="text-sm">Select roles above to see which users will have access to this bot.</p>
                                </div>
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              }
              @case ('assign') {
                <div class="px-6 py-6 text-sm text-gray-700">
                  <div class="text-center py-12">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" />
                    </svg>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Assign Functionality</h3>
                    <p class="text-gray-500 max-w-md mx-auto">This tab will contain assignment functionality in the future. It's currently a placeholder for upcoming features.</p>
                  </div>
                </div>
              }
            }
          </div>

          <div class="bg-gray-50 border-t border-gray-200 px-6 py-4">
            <div class="flex items-center justify-end gap-2">
              <button type="button" (click)="onCancel()" class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
              <button type="button" (click)="onSave()" class="px-3 py-2 text-sm font-medium text-white bg-pink-600 rounded-md hover:bg-pink-700">Save</button>
            </div>
          </div>
        </aside>
      }
    </div>
  }
</section>
